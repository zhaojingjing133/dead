# 死了吗 - 接口需求文档

## 1. 文档说明

| 项目     | 说明                     |
|----------|--------------------------|
| 产品名称 | 死了吗                   |
| 文档类型 | 后端接口需求（API 规格） |
| 用途     | 直接用于指导后端开发     |
| 关联文档 | [数据库设计文档.md](./数据库设计文档.md) |

**业务流程简述**：用户每日签到；若**连续 2 天**未签到，系统向用户邮箱发送提醒邮件。用户身份由微信小程序 openid 标识，签到接口需完成「用户识别/创建 + 今日签到落库」。

---

## 2. 通用约定

### 2.1 请求

- **Base URL**：由部署环境决定，前端在 `common/config.js` 中配置（如开发 `http://localhost:3000`，生产需配置为后端实际域名）。
- **Content-Type**：`application/json`。
- **字符编码**：UTF-8。

### 2.2 用户身份（微信小程序）

- 用户唯一标识为微信 **openid**（见数据库设计文档 `users.openid`）。
- 小程序端通过 **wx.login** 获取临时 `code`，后端用 `code` 向微信接口换取 `openid`（及可选 `session_key`）。
- 本需求约定：**签到接口** 请求体中携带 `code`，后端先根据 `code` 解析出 openid，再执行「用户创建/更新 + 签到」逻辑；若后续增加 token 鉴权，可再扩展登录接口与请求头 `Authorization`。

### 2.3 统一响应格式

**成功（HTTP 2xx）**：业务数据放在 `data` 中，可带 `message`。

```json
{
  "code": 0,
  "message": "签到成功",
  "data": { ... }
}
```

**失败（HTTP 4xx/5xx）**：错误信息统一格式。

```json
{
  "code": 非0错误码,
  "message": "错误描述，可直接给用户或前端展示"
}
```

- HTTP 状态码与业务 `code` 可同时使用：如 200 + `code: 0` 表示成功，400 + `code: 40001` 表示参数错误。
- 前端当前以 HTTP 状态码 2xx 判定成功，并从 `res.data` 取响应体；失败时以 `message` 提示用户。

### 2.4 错误码约定（建议）

| 错误码 | 含义       | HTTP 状态码建议 |
|--------|------------|------------------|
| 0      | 成功       | 200              |
| 40001  | 参数错误   | 400              |
| 40101  | 未登录/ code 无效 | 401              |
| 40301  | 用户已禁用 | 403              |
| 40901  | 今日已签到（重复签到） | 409              |
| 50001  | 服务器内部错误 | 500              |

---

## 3. 接口列表

| 序号 | 方法   | 路径            | 说明                     |
|------|--------|-----------------|--------------------------|
| 1    | POST   | /api/check-in   | 每日签到（用户识别 + 写库） |

---

## 4. 接口详细说明

### 4.1 每日签到 `POST /api/check-in`

**功能**：根据微信 `code` 识别/创建用户，更新昵称与邮箱，并记录今日签到。同一用户同一天多次调用按「今日已签到」处理（见数据库 `check_ins` 唯一约束）。

**请求**

- **Header**  
  - `Content-Type: application/json`

- **Body（JSON）**

| 字段名    | 类型   | 必填 | 说明 |
|-----------|--------|------|------|
| code      | string | 是   | 微信 wx.login 返回的临时 code，用于后端换取 openid |
| nickname  | string | 是   | 用户昵称（姓名），建议长度限制与 DB 一致（如 64 字符） |
| email     | string | 是   | 接收提醒的邮箱，建议格式校验与长度限制（如 255 字符） |

示例：

```json
{
  "code": "0x1a2b3c4d...",
  "nickname": "张三",
  "email": "zhangsan@example.com"
}
```

**成功响应**

- HTTP 状态码：`200`
- Body 示例：

```json
{
  "code": 0,
  "message": "签到成功",
  "data": {
    "checkInDate": "2026-01-30",
    "message": "今日已签到"
  }
}
```

- `checkInDate`：本次签到日期（自然日），格式 `YYYY-MM-DD`；可选返回，便于前端展示。

**失败响应**

- **参数错误**（缺少 code/nickname/email 或格式不合法）  
  - HTTP `400`  
  - Body 示例：`{ "code": 40001, "message": "请输入姓名和邮箱" }`

- **code 无效或换取 openid 失败**  
  - HTTP `401`  
  - Body 示例：`{ "code": 40101, "message": "登录已过期，请重新打开小程序" }`

- **用户已禁用**（`users.status = 0`）  
  - HTTP `403`  
  - Body 示例：`{ "code": 40301, "message": "账号已停用" }`

- **今日已签到**（同一 openid 当日已有签到记录）  
  - HTTP `409`  
  - Body 示例：`{ "code": 40901, "message": "今日已签到过了" }`  
  - 可选：仍返回 200 且 `data.message = "今日已签到"`，由产品决定。

- **服务器错误**  
  - HTTP `500`  
  - Body 示例：`{ "code": 50001, "message": "签到失败，请稍后重试" }`

**后端处理逻辑（建议顺序）**

1. 校验必填：`code`、`nickname`、`email`；校验邮箱格式、长度。
2. 用 `code` 调用微信接口换取 `openid`（及可选 `session_key`）；失败则返回 401。
3. 按 `openid` 查询 `users`：
   - 不存在：插入新用户（openid、nickname、email、status=1），得到 `user_id`。
   - 存在：若用户 `status = 0` 则返回 403；否则更新 `nickname`、`email`、`updated_at`。
4. 查询 `check_ins`：是否存在 `user_id` + 今日日期（自然日）的记录。
   - 已存在：按产品约定返回 409 或 200 + “今日已签到”。
   - 不存在：插入一条 `check_ins`（user_id、check_in_date=今日、created_at），返回 200 + 成功信息。
5. 邮件提醒为**异步/定时任务**逻辑，不在此接口内同步发送；实现方式见下文「非接口需求」。

**与数据库的对应关系**

- **users**：根据 openid 存在与否，执行 INSERT 或 UPDATE（email、nickname、updated_at）；主键即 `user_id`。
- **check_ins**：INSERT 一条记录，字段 `user_id`、`check_in_date`（今日）、`created_at`；需保证 `(user_id, check_in_date)` 唯一（表设计见《数据库设计文档》）。

---

## 5. 非接口需求（供后端实现参考）

以下不对外暴露为前端调用的 HTTP 接口，但需后端实现，以便与接口和数据库一致。

### 5.1 微信 code 换 openid

- 使用微信接口：`GET https://api.weixin.qq.com/sns/jscode2session?appid=APPID&secret=SECRET&js_code=CODE&grant_type=authorization_code`
- 返回中有 `openid`（必用）、`session_key`（可选保存或用于生成自定义登录态）。
- AppID、Secret 来自微信小程序后台，需配置在后端环境变量或配置中心。

### 5.2 连续 2 天未签到的邮件提醒

- **触发条件**：以服务器当前日期为 `today`，用户**最后一次签到日期 < today - 1**（即昨天和今天都未签到），且**今日尚未对该用户发过提醒**。
- **去重**：通过表 `email_notifications` 在同一自然日内同一 `user_id` 仅插入/发送一条；发送前查询「该用户今日是否已有记录」。
- **实现方式**：定时任务（如每日固定时间扫描）或「签到接口」之后的异步任务队列；具体频率与重试策略由后端定。
- **邮件内容、模板、发件服务**：由后端自行选型（如 SMTP、SendGrid 等）；`email_notifications` 表字段见《数据库设计文档》（含 send_status、reason、content 等）。

### 5.3 用户状态与提醒次数

- `users.status`：1=正常，0=禁用。业务规则可在「发满 N 封提醒仍未签到」时将用户置为 0，并停止后续提醒；N 由产品/配置决定（文档中示例为 5）。
- `email_notifications.sequence`：表示该用户被提醒的第几次；`reason` 建议为 `consecutive_2_days` 等，见《数据库设计文档》。

---

## 6. 与前端对接要点

- 前端当前仅调用 **POST /api/check-in**，请求体为 `{ nickname, email }`。  
- **需前端配合**：在小程序内先调用 `wx.login` 获取 `code`，在请求体中增加 `code` 字段后再调用 `/api/check-in`，否则后端无法识别用户。  
- 前端已做：姓名、邮箱必填及简单邮箱格式校验；失败时用接口返回的 `message` 提示用户。

---

## 7. 修订记录

| 版本   | 日期       | 说明         |
|--------|------------|--------------|
| 1.0    | 2026-01-30 | 初稿：签到接口 + 通用约定 + 非接口需求 |
