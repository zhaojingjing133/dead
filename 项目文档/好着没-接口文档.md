# 好着没 - 后端接口文档

**版本**：1.0  
**更新日期**：2026-01-30

---

## 1. 概述

| 项目 | 说明 |
|------|------|
| 产品名称 | 好着没 |
|  Base URL | 开发：`http://localhost:3000`<br>Sealos 部署：`https://qxzprrbklqtx.usw-1.sealos.app`（端口 8080） |
| Content-Type | `application/json` |
| 字符编码 | UTF-8 |

**业务流程**：用户每日签到一次；若连续 2 天未签到，系统向用户邮箱发送提醒邮件（内容：「我连续2天都不好，快给我打个电话吧！」）。

---

## 2. 接口列表

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/health | 健康检查（数据库连接） |
| POST | /api/check-in | 每日签到 |
| POST | /api/cron/reminder | 手动触发提醒任务（测试用） |

---

## 3. 接口详情

### 3.1 健康检查 `GET /api/health`

**说明**：检查服务与数据库连接状态。

**请求**：无参数

**成功响应** (200)
```json
{
  "code": 0,
  "message": "OK",
  "data": {
    "db": "connected"
  }
}
```

---

### 3.2 每日签到 `POST /api/check-in`

**说明**：根据微信 `code` 识别/创建用户，更新昵称与邮箱，并记录今日签到。

**请求头**：`Content-Type: application/json`

**请求体**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| code | string | 是 | 微信 `wx.login` 返回的临时 code |
| nickname | string | 是 | 用户昵称（姓名） |
| email | string | 是 | 接收提醒的邮箱 |

**请求示例**
```json
{
  "code": "0x1a2b3c4d...",
  "nickname": "张三",
  "email": "zhangsan@example.com"
}
```

**成功响应** (200) - 首次签到
```json
{
  "code": 0,
  "message": "签到成功",
  "data": {
    "checkInDate": "2026-01-30"
  }
}
```

**成功响应** (200) - 今日已签到
```json
{
  "code": 0,
  "message": "今日已签到",
  "data": {
    "checkInDate": "2026-01-30",
    "message": "今日已签到过了"
  }
}
```

**错误响应**

| HTTP | code | message |
|------|------|---------|
| 400 | 40001 | 请输入姓名和邮箱 |
| 400 | 40001 | 邮箱格式不正确 |
| 401 | 40101 | 登录已过期，请重新打开小程序 |
| 403 | 40301 | 账号已停用 |
| 500 | 50001 | 签到失败，请稍后重试 |

---

### 3.3 手动触发提醒 `POST /api/cron/reminder`

**说明**：立即执行「连续2天未签到」用户的邮件发送，用于测试。生产环境建议删除或加鉴权。

**请求**：无参数

**成功响应** (200)
```json
{
  "code": 0,
  "message": "已执行"
}
```

---

## 4. 错误码一览

| 错误码 | 含义 |
|--------|------|
| 0 | 成功 |
| 40001 | 参数错误 |
| 40101 | 未登录 / code 无效 |
| 40301 | 用户已禁用 |
| 40901 | 今日已签到（重复） |
| 50001 | 服务器内部错误 |

---

## 5. 配置说明

关键配置存放于 `.env`，参考 `.env.example`。缺失配置时接口会返回相应错误。

### 5.1 服务器
- `NODE_ENV`：development / production
- `HOST`：`0.0.0.0` 允许外网访问（部署 Sealos 必填）
- `PORT`：监听端口，本地 3000，Sealos 部署 8080

### 5.2 数据库
- `DB_HOST` `DB_PORT` `DB_USER` `DB_PASSWORD` `DB_NAME`
- 本地开发：公网 `dbconn.usw-1.sealos.app:34575`
- DevBox：内网 `areyoudead-mysql.ns-bbah8da5.svc:3306`

### 5.3 微信小程序
- `WECHAT_APPID` `WECHAT_SECRET`
- 获取：微信公众平台 → 开发 → 开发管理 → 开发设置

### 5.4 邮件服务
- `SMTP_HOST` `SMTP_PORT` `SMTP_SECURE` `SMTP_USER` `SMTP_PASS` `SMTP_FROM`
- **QQ 邮箱**：smtp.qq.com，465，开启 SMTP 后使用授权码（非登录密码）
- **163 邮箱**：smtp.163.com，465，同上
- `EMAIL_REMINDER_CONTENT`：提醒邮件正文，默认「我连续2天都不好，快给我打个电话吧！」

### 5.5 定时任务
- 每日 **20:00** 自动执行「连续2天未签到」用户的邮件提醒
